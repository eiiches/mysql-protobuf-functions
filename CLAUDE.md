# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a MySQL Protocol Buffers (protobuf) functions library that provides comprehensive MySQL stored functions and procedures for working with protobuf encoded data directly within MySQL databases. The project enables parsing and querying protobuf messages without requiring external applications.

## Core Architecture

### SQL Functions Layer
- **protobuf.sql**: Core protobuf wire format parsing functions
- **protobuf-accessors.sql**: Generated accessor functions for different protobuf types (auto-generated by Go code)
- **protobuf-descriptor.sql**: Schema loading and descriptor management
- **protobuf-json.sql**: JSON conversion functionality

### Go Development Tools
- **cmd/protobuf-accessors/**: Code generator for MySQL accessor functions
- **cmd/mysql-profiler/**: Performance profiling tool that generates flamegraphs from MySQL performance schema
- **cmd/mysql-coverage/**: SQL code coverage analysis tool with LCOV report generation
- **cmd/mysql-ftrace/**: Function tracing tool for SQL execution analysis
- **internal/**: Supporting Go packages for protobuf reflection, MySQL utilities, and testing

### Key Components
- **Wire format parsing**: Low-level protobuf wire format decoding in pure MySQL
- **Type system**: Comprehensive support for all protobuf types (varint, fixed32/64, length-delimited)
- **JSON conversion**: Protobuf to JSON transformation with schema awareness
- **Performance profiling**: MySQL performance analysis and flamegraph generation
- **Coverage analysis**: SQL code coverage tracking with LCOV report generation
- **Function tracing**: Detailed SQL function execution tracing and analysis

## Development Commands

### Build System
```bash
# Build generated SQL files
make build

# Reload all SQL functions into database
make reload

# Run tests (requires running MySQL)
make test

# Full rebuild and test cycle
make purge reload test
```

### MySQL Management
```bash
# Start local MySQL instance
make start-mysql

# Stop MySQL instance
make stop-mysql

# Open MySQL shell
make mysql-shell

# Show debug logs
make show-logs
```

### Testing
```bash
# Run Go tests against MySQL
go test ./tests -database "root@tcp(127.0.0.100:13306)/test"

# Run specific test
go test ./tests -run TestSomething -database "root@tcp(127.0.0.100:13306)/test"
```

### Performance Analysis
```bash
# Start profiling
make start-profiling

# Stop profiling and generate report
make stop-profiling

# Generate flamegraph from MySQL performance data
make flamegraph
```

### Function Tracing
```bash
# Load instrumented functions for tracing (creates and loads .ftraced files)
make load-ftrace-instrumented-files

# Generate trace report after running tests
./mysql-ftrace report --database "root@tcp(127.0.0.100:13306)/test" --format text
```

### Code Generation
```bash
# Generate protobuf accessor functions
go run cmd/protobuf-accessors/main.go > protobuf-accessors.sql
```

### Code Formatting
```bash
# Format Go code (run after modifying Go code)
make format

# Run Go linting (check code quality and style)
make lint
```

## Development Workflow

1. **SQL Development**: Core protobuf functionality is implemented in MySQL stored functions/procedures
2. **Go Tools**: Supporting tools for code generation, testing, and profiling
3. **Code Formatting**: Always run `make format` after modifying Go code to ensure consistent formatting
4. **Test-Driven**: Tests run against live MySQL instance to verify SQL function behavior
5. **Performance Focus**: Built-in profiling and flamegraph generation for performance analysis

## Database Schema

The project creates tables prefixed with `_Proto_` for protobuf schema storage and functions prefixed with `pb_` or `_pb_` for protobuf operations.

## Testing Requirements

- Tests require a running MySQL instance (started with `make start-mysql`)
- Database connection string must be provided via `-database` flag
- Tests use Gomega for assertions and custom MySQL matchers

## Development Best Practices

- Remove any trailing whitespaces after editing SQL files