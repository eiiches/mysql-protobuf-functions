# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a MySQL Protocol Buffers (protobuf) functions library that provides comprehensive MySQL stored functions and procedures for working with protobuf encoded data directly within MySQL databases. The project enables parsing and querying protobuf messages without requiring external applications.

## Core Architecture

### SQL Functions Layer
- **protobuf.sql**: Core protobuf wire format parsing functions
- **protobuf-accessors.sql**: Generated accessor functions for different protobuf types (auto-generated by Go code)
- **protobuf-descriptor.sql**: Schema loading and descriptor management
- **protobuf-json.sql**: JSON conversion functionality

### Go Development Tools
- **cmd/protobuf-accessors/**: Code generator for MySQL accessor functions
- **cmd/mysql-profiler/**: Performance profiling tool that generates flamegraphs from MySQL performance schema
- **internal/**: Supporting Go packages for protobuf reflection, MySQL utilities, and testing

### Key Components
- **Wire format parsing**: Low-level protobuf wire format decoding in pure MySQL
- **Type system**: Comprehensive support for all protobuf types (varint, fixed32/64, length-delimited)
- **JSON conversion**: Protobuf to JSON transformation with schema awareness
- **Performance profiling**: MySQL performance analysis and flamegraph generation

## Development Commands

### Build System
```bash
# Build generated SQL files
make build

# Reload all SQL functions into database
make reload

# Run tests (requires running MySQL)
make test

# Full rebuild and test cycle
make purge reload test
```

### MySQL Management
```bash
# Start local MySQL instance
make start-mysql

# Stop MySQL instance
make stop-mysql

# Open MySQL shell
make mysql-shell

# Show debug logs
make show-logs
```

### Testing
```bash
# Run Go tests against MySQL
go test ./tests -database "root@tcp(127.0.0.100:13306)/test"

# Run specific test
go test ./tests -run TestSomething -database "root@tcp(127.0.0.100:13306)/test"
```

### Performance Analysis
```bash
# Start profiling
make start-profiling

# Stop profiling and generate report
make stop-profiling

# Generate flamegraph from MySQL performance data
make flamegraph
```

### Code Generation
```bash
# Generate protobuf accessor functions
go run cmd/protobuf-accessors/main.go > protobuf-accessors.sql
```

## Development Workflow

1. **SQL Development**: Core protobuf functionality is implemented in MySQL stored functions/procedures
2. **Go Tools**: Supporting tools for code generation, testing, and profiling
3. **Test-Driven**: Tests run against live MySQL instance to verify SQL function behavior
4. **Performance Focus**: Built-in profiling and flamegraph generation for performance analysis

## Database Schema

The project creates tables prefixed with `_Proto_` for protobuf schema storage and functions prefixed with `pb_` or `_pb_` for protobuf operations.

## Testing Requirements

- Tests require a running MySQL instance (started with `make start-mysql`)
- Database connection string must be provided via `-database` flag
- Tests use Gomega for assertions and custom MySQL matchers