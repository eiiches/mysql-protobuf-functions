# protoc-gen-mysql

A protoc plugin and standalone tool that generates MySQL stored functions containing [descriptor set JSON](../../internal/descriptorsetjson/README.md) for protobuf schemas. This enables runtime protobuf reflection and JSON conversion for custom schemas.

## Quick Start

1. **Install the plugin:**
   ```bash
   go install github.com/eiiches/mysql-protobuf-functions/cmd/protoc-gen-mysql@latest
   ```

2. **Generate schema function from your .proto file:**
   ```bash
   protoc --mysql_out=. --mysql_opt=name=my_schema my_schema.proto
   ```

3. **Load into MySQL and use:**
   ```bash
   # Load the generated function
   mysql -u your_username -p your_database < my_schema.sql
   ```

   ```sql
   -- Parse protobuf messages using your schema
   SELECT pb_message_to_json(
       my_schema(),
       '.MyMessage',
       my_protobuf_blob
   ) AS json_result;
   ```

## Usage Modes

This tool can be used in two ways:

### 1. As a Protoc Plugin (Recommended)

Use with `protoc` to generate schema functions directly from .proto files:

```bash
protoc --mysql_out=. --mysql_opt=name=my_schema my_schema.proto
```

### 2. As a Standalone Tool

Use with pre-generated binary FileDescriptorSet files:

```bash
# First, generate binary descriptor set
protoc --descriptor_set_out=schema.binpb --include_imports my_schema.proto

# Then generate SQL function from binary descriptor set  
protoc-gen-mysql \
  --descriptor_set_in=schema.binpb \
  --name=my_schema \
  --mysql_out=./output
```

## Plugin Options (Protoc Plugin Mode)

| Option | Required | Default Value | Description |
|--------|----------|---------------|-------------|
| `name` | Yes | - | Name of the generated SQL function and file |
| `include_source_info` | No | `false` | Include source code info in output (increases output size significantly) |

## Command Line Options (Standalone Mode)

| Option | Required | Default Value | Description |
|--------|----------|---------------|-------------|
| `--descriptor_set_in` | Yes | - | Path to binary FileDescriptorSet file |
| `--name` | Yes | - | Name of the generated SQL function and file |
| `--include_source_info` | No | `false` | Include source code info in output (increases output size significantly) |
| `--mysql_out` | No | `.` | Output directory for generated SQL files |

## Generated Output

The plugin generates a SQL file containing a stored function that returns descriptor set JSON in the format expected by `pb_message_to_json()` and related functions.

### Generated Function Structure

```sql
-- Code generated by protoc-gen-mysql. DO NOT EDIT.

DELIMITER $$

DROP FUNCTION IF EXISTS your_function_name $$
CREATE FUNCTION your_function_name() RETURNS JSON DETERMINISTIC
BEGIN
	RETURN CAST('[1, {...}, {...}]' AS JSON);
END $$
```

### Descriptor Set JSON Format

The returned JSON is a versioned 3-element array: `[version, fileDescriptorSet, typeIndex]`

For complete details about the format structure, see the [descriptorsetjson documentation](../../internal/descriptorsetjson/README.md).

## Example

### Person Schema

Given the `person.proto` schema:

```protobuf
syntax = "proto3";

import "google/protobuf/timestamp.proto";

message Person {
  string name = 1;
  int32 id = 2;
  string email = 3;

  enum PhoneType {
    PHONE_TYPE_UNSPECIFIED = 0;
    PHONE_TYPE_MOBILE = 1;
    PHONE_TYPE_HOME = 2;
    PHONE_TYPE_WORK = 3;
  }

  message PhoneNumber {
    string number = 1;
    PhoneType type = 2;
  }

  repeated PhoneNumber phones = 4;
  google.protobuf.Timestamp last_updated = 5;
}
```

Generate the descriptor set function:

```bash
# Generate function for person schema
protoc --mysql_out=. \
       --mysql_opt=name=person_schema \
       person.proto

# Or using standalone mode
protoc --descriptor_set_out=person.binpb --include_imports person.proto
protoc-gen-mysql \
  --descriptor_set_in=person.binpb \
  --name=person_schema
```

### Generated File

For the person.proto schema above, the plugin generates `person_schema.sql`:

```sql
-- Code generated by protoc-gen-mysql. DO NOT EDIT.

DELIMITER $$

DROP FUNCTION IF EXISTS person_schema $$
CREATE FUNCTION person_schema() RETURNS JSON DETERMINISTIC
BEGIN
	RETURN CAST('[1,{"1":[{"1":"google/protobuf/timestamp.proto","10":[],"11":[],"12":"proto3","2":"google.protobuf","3":[],"4":[{"1":"Timestamp","10":[],"2":[{"1":"seconds","10":"seconds","3":1,"4":1,"5":3},{"1":"nanos","10":"nanos","3":2,"4":1,"5":5}],"3":[],"4":[],"5":[],"6":[],"8":[],"9":[]}],"5":[],"6":[],"7":[],"8":{"1":"com.google.protobuf","10":true,"11":"google.golang.org/protobuf/types/known/timestamppb","31":true,"36":"GPB","37":"Google.Protobuf.WellKnownTypes","8":"TimestampProto","999":[]}},{"1":"person.proto","10":[],"11":[],"12":"proto3","3":["google/protobuf/timestamp.proto"],"4":[{"1":"Person","10":[],"2":[{"1":"name","10":"name","3":1,"4":1,"5":9},{"1":"id","10":"id","3":2,"4":1,"5":5},{"1":"email","10":"email","3":3,"4":1,"5":9},{"1":"phones","10":"phones","3":4,"4":3,"5":11,"6":".Person.PhoneNumber"},{"1":"last_updated","10":"lastUpdated","3":5,"4":1,"5":11,"6":".google.protobuf.Timestamp"}],"3":[{"1":"PhoneNumber","10":[],"2":[{"1":"number","10":"number","3":1,"4":1,"5":9},{"1":"type","10":"type","3":2,"4":1,"5":14,"6":".Person.PhoneType"}],"3":[],"4":[],"5":[],"6":[],"8":[],"9":[]}],"4":[{"1":"PhoneType","2":[{"1":"PHONE_TYPE_UNSPECIFIED","2":0},{"1":"PHONE_TYPE_MOBILE","2":1},{"1":"PHONE_TYPE_HOME","2":2},{"1":"PHONE_TYPE_WORK","2":3}],"4":[],"5":[]}],"5":[],"6":[],"8":[],"9":[]}],"5":[],"6":[],"7":[]}]},{".Person":[11,"$[1].\\"1\\"[1]","$[1].\\"1\\"[1].\\"4\\"[0]"],".Person.PhoneNumber":[11,"$[1].\\"1\\"[1]","$[1].\\"1\\"[1].\\"4\\"[0].\\"3\\"[0]"],".Person.PhoneType":[14,"$[1].\\"1\\"[1]","$[1].\\"1\\"[1].\\"4\\"[0].\\"4\\"[0]"],".google.protobuf.Timestamp":[11,"$[1].\\"1\\"[0]","$[1].\\"1\\"[0].\\"4\\"[0]"]}]' AS JSON);
END $$
```

## Troubleshooting

### Plugin not found in PATH

If you get an error like `protoc-gen-mysql: program not found or is not executable`, the plugin may not be in your PATH. You can either add it to your PATH or specify the full path using the `--plugin` option:

```bash
protoc --plugin=protoc-gen-mysql=/path/to/protoc-gen-mysql \
       --mysql_out=. \
       --mysql_opt=name=my_schema \
       my_schema.proto
```
